<% content_for :page_title, "Editar Rol" %>

<div class="max-w-6xl mx-auto space-y-6">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm p-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <div class="flex-shrink-0 h-12 w-12">
          <div class="h-12 w-12 rounded-full bg-wine-primary flex items-center justify-center">
            <span class="text-white font-semibold text-lg">üîê</span>
          </div>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">‚úèÔ∏è Editar Rol</h1>
          <p class="text-gray-600"><%= @role.name.humanize %> - <%= @role.users.count %> usuarios asignados</p>
        </div>
      </div>
      <div class="flex space-x-3">
        <%= link_to admin_role_path(@role), 
            class: "inline-flex items-center px-4 py-2 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition-colors" do %>
          üëÅÔ∏è Ver Detalles
        <% end %>
        <%= link_to admin_roles_path, 
            class: "inline-flex items-center px-4 py-2 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition-colors" do %>
          ‚Üê Volver
        <% end %>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="bg-white rounded-lg shadow-sm p-6">
    <%= form_with model: [:admin, @role], local: true, class: "space-y-8" do |form| %>
      
      <!-- Display errors if any -->
      <% if @role.errors.any? %>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <span class="text-red-400 text-xl">‚ö†Ô∏è</span>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">
                Se encontraron <%= pluralize(@role.errors.count, "error") %>:
              </h3>
              <div class="mt-2 text-sm text-red-700">
                <ul class="list-disc pl-5 space-y-1">
                  <% @role.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Basic Information -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìù Informaci√≥n B√°sica</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= form.label :name, "Nombre del Rol *", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :name, 
                class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wine-primary focus:border-transparent" %>
            <p class="mt-1 text-sm text-gray-500">Cambiar el nombre puede afectar las referencias en el c√≥digo</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
            <div class="flex items-center">
              <%= form.check_box :active, 
                  { class: "h-4 w-4 text-wine-primary focus:ring-wine-primary border-gray-300 rounded" },
                  true, false %>
              <%= form.label :active, "Rol activo", class: "ml-2 block text-sm text-gray-900" %>
            </div>
            <p class="mt-1 text-sm text-gray-500">Los roles inactivos no pueden ser asignados a nuevos usuarios</p>
          </div>

          <div class="md:col-span-2">
            <%= form.label :description, "Descripci√≥n", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_area :description, 
                class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-wine-primary focus:border-transparent",
                rows: 3 %>
          </div>
        </div>
      </div>

      <!-- Current Users with this Role -->
      <% if @role.users.any? %>
        <div class="bg-blue-50 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üë• Usuarios con este Rol</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <% @role.users.includes(:roles).limit(6).each do |user| %>
              <div class="flex items-center space-x-3 p-3 bg-white rounded-lg border">
                <div class="flex-shrink-0 h-8 w-8">
                  <div class="h-8 w-8 rounded-full bg-wine-primary flex items-center justify-center">
                    <span class="text-white text-xs font-medium">
                      <%= user.first_name[0]&.upcase %><%= user.last_name[0]&.upcase %>
                    </span>
                  </div>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate"><%= user.full_name %></p>
                  <p class="text-sm text-gray-500 truncate"><%= user.email %></p>
                </div>
              </div>
            <% end %>
            <% if @role.users.count > 6 %>
              <div class="flex items-center justify-center p-3 bg-gray-100 rounded-lg border border-dashed">
                <span class="text-sm text-gray-600">+<%= @role.users.count - 6 %> usuarios m√°s</span>
              </div>
            <% end %>
          </div>
          <div class="mt-4 p-3 bg-white rounded-lg border-l-4 border-yellow-400">
            <p class="text-sm text-yellow-700">
              ‚ö†Ô∏è <strong>Nota:</strong> Los cambios en los permisos afectar√°n a todos los usuarios con este rol.
            </p>
          </div>
        </div>
      <% end %>

      <!-- Permissions Assignment -->
      <div class="bg-gray-50 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">üõ°Ô∏è Permisos Asignados</h3>
          <div class="flex items-center space-x-2 text-sm text-gray-600">
            <span>Permisos seleccionados: <strong id="selected-count"><%= @role_permission_ids.count %></strong></span>
            <span>de <strong><%= Permission.count %></strong></span>
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-6">Modifica los permisos que tendr√° este rol. Los cambios se aplicar√°n inmediatamente a todos los usuarios.</p>
        
        <% if @permission_groups.any? %>
          <div class="space-y-6">
            <% @permission_groups.each do |resource, permissions| %>
              <div class="border border-gray-200 rounded-lg p-4 hover:bg-white transition-colors">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-base font-medium text-gray-900 flex items-center">
                    <span class="mr-2">
                      <% case resource %>
                      <% when 'users' %>
                        üë•
                      <% when 'roles' %>
                        üîê
                      <% when 'permissions' %>
                        üõ°Ô∏è
                      <% when 'employees' %>
                        üë®‚Äçüíº
                      <% when 'dashboard' %>
                        üìä
                      <% when 'reports' %>
                        üìà
                      <% else %>
                        üìÑ
                      <% end %>
                    </span>
                    <% 
                      resource_spanish = case resource
                      when 'users'
                        'Usuarios'
                      when 'roles'
                        'Roles'
                      when 'permissions'
                        'Permisos'
                      when 'employees'
                        'Empleados'
                      when 'dashboard'
                        'Panel'
                      when 'reports'
                        'Reportes'
                      else
                        resource.humanize
                      end
                    %>
                    <%= resource_spanish %>
                    <span class="ml-2 text-sm text-gray-500">
                      (<span id="<%= resource %>-selected"><%= permissions.count { |p| @role_permission_ids.include?(p.id) } %></span>/<%= permissions.count %>)
                    </span>
                  </h4>
                  <div class="flex items-center space-x-2">
                    <button type="button" 
                            onclick="selectAllInGroup('<%= resource %>')"
                            class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors">
                      Seleccionar Todos
                    </button>
                    <button type="button" 
                            onclick="deselectAllInGroup('<%= resource %>')"
                            class="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors">
                      Deseleccionar
                    </button>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                  <% permissions.each do |permission| %>
                    <div class="flex items-start space-x-2 p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                      <div class="flex items-center h-5">
                        <%= check_box_tag "role[permission_ids][]", permission.id, @role_permission_ids.include?(permission.id), 
                            { class: "h-4 w-4 text-wine-primary focus:ring-wine-primary border-gray-300 rounded permission-checkbox",
                              data: { resource: resource },
                              onchange: "updateCounts()" } %>
                      </div>
                      <div class="flex-1 min-w-0">
                        <label class="text-sm font-medium text-gray-900 cursor-pointer block">
                          <%= permission.action_in_spanish %>
                        </label>
                        <% if permission.description.present? %>
                          <p class="text-xs text-gray-500 mt-1"><%= permission.description %></p>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          
          <!-- Hidden field to handle empty selection -->
          <%= hidden_field_tag "role[permission_ids][]", "" %>
          
        <% else %>
          <div class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
            <div class="text-gray-400 text-4xl mb-2">üõ°Ô∏è</div>
            <p class="text-gray-500">No hay permisos disponibles en el sistema.</p>
          </div>
        <% end %>
      </div>

      <!-- Role Information (Read-only) -->
      <div class="bg-blue-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Informaci√≥n del Rol</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <dt class="text-sm font-medium text-gray-500">Rol creado</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <%= l(@role.created_at, format: :short) %>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">√öltima modificaci√≥n</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <%= l(@role.updated_at, format: :short) %>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Usuarios asignados</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @role.users.count %></dd>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
        <%= link_to admin_role_path(@role), 
            class: "px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors" do %>
          Cancelar
        <% end %>
        
        <%= form.submit "Actualizar Rol", 
            class: "px-6 py-3 bg-wine-primary text-white font-medium rounded-lg hover:bg-wine-secondary transition-colors cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  function selectAllInGroup(resource) {
    const checkboxes = document.querySelectorAll(`input[data-resource="${resource}"]`);
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateCounts();
  }
  
  function deselectAllInGroup(resource) {
    const checkboxes = document.querySelectorAll(`input[data-resource="${resource}"]`);
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateCounts();
  }
  
  function updateCounts() {
    // Update total selected count
    const totalSelected = document.querySelectorAll('input.permission-checkbox:checked').length;
    document.getElementById('selected-count').textContent = totalSelected;
    
    // Update per-resource counts
    const resources = ['users', 'roles', 'permissions', 'employees', 'dashboard', 'reports'];
    resources.forEach(resource => {
      const selectedInResource = document.querySelectorAll(`input[data-resource="${resource}"]:checked`).length;
      const element = document.getElementById(`${resource}-selected`);
      if (element) {
        element.textContent = selectedInResource;
      }
    });
  }
  
  // Initialize counts on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateCounts();
  });
</script>