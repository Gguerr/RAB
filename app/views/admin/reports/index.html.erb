<% content_for :page_title, "Generador de Reportes" %>

<div class="space-y-6">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm p-6">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-gray-900">📊 Generador de Reportes</h2>
        <p class="text-gray-600 mt-1">Genera reportes personalizados en PDF con filtros avanzados</p>
      </div>
      
      <div class="flex items-center space-x-4 text-sm text-gray-500">
        <div class="flex items-center">
          <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
          Sistema Activo
        </div>
        <div>
          Última actualización: <%= Time.current.strftime('%d/%m/%Y %H:%M') %>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Types Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    <% @report_types.each do |report| %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
        <!-- Report Header -->
        <div class="p-6 border-b border-gray-100">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-12 w-12 bg-<%= report[:color] %>-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl"><%= report[:icon] %></span>
              </div>
              <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900"><%= report[:name] %></h3>
              </div>
            </div>
          </div>
          
          <p class="text-sm text-gray-600 mb-4"><%= report[:description] %></p>
          
          <!-- Quick Stats -->
          <div class="text-xs text-gray-500 mb-4">
            <% case report[:id] %>
            <% when 'employees' %>
              Total empleados: <strong><%= Employee.count %></strong> | 
              Activos: <strong><%= Employee.active.count %></strong>
            <% when 'payment_accounts' %>
              Total cuentas: <strong><%= PaymentAccount.count %></strong> | 
              Activas: <strong><%= PaymentAccount.where(active: true).count %></strong>
            <% when 'family' %>
              Total familiares: <strong><%= FamilyMember.count %></strong>
            <% when 'sizes' %>
              Total registros: <strong><%= WorkerSize.count %></strong>
            <% when 'cards' %>
              Con carnet partido: <strong><%= Employee.joins(:party_card).count %></strong> | 
              Con carnet PSUV: <strong><%= Employee.joins(:psuv_card).count %></strong>
            <% when 'bank_accounts_detailed' %>
              Total cuentas: <strong><%= PaymentAccount.count %></strong> | 
              Bancarias: <strong><%= PaymentAccount.where(account_type: 'bank').count %></strong>
            <% when 'family_detailed' %>
              Total hijos: <strong><%= FamilyMember.count %></strong> | 
              Masculinos: <strong><%= FamilyMember.where(gender: 'masculino').count %></strong> | 
              Femeninos: <strong><%= FamilyMember.where(gender: 'femenino').count %></strong>
            <% when 'sizes_detailed' %>
              Total registros: <strong><%= WorkerSize.count %></strong>
            <% when 'vacation_report' %>
              Próximas vacaciones: <strong><%= Employee.where('vacation_date >= ? AND vacation_date <= ?', Date.current, Date.current + 30.days).count %></strong>
            <% when 'vacation_request' %>
              Formulario oficial: <strong>Listo para usar</strong>
            <% end %>
          </div>
        </div>

        <!-- Actions -->
        <div class="p-6">
          <div class="flex space-x-3">
            <% if report[:id] == 'family_detailed' %>
              <%= form_with url: generate_direct_admin_reports_path, method: :post, local: true, data: { turbo: false }, style: "display: inline-block;" do |f| %>
                <%= f.hidden_field :type, value: 'family_detailed' %>
                <%= f.submit "📊 Generar PDF Directo", class: "btn-generate-report", style: "border: none; cursor: pointer;" %>
              <% end %>
            <% else %>
              <%= link_to new_admin_report_path + "?type=#{report[:id]}", 
                  class: "btn-generate-report" do %>
                <span class="mr-2">📋</span>
                Generar Reporte
              <% end %>
            <% end %>
            
            <button type="button" 
                    onclick="showReportPreview('<%= report[:id] %>')"
                    class="btn-preview"
                    title="Vista previa">
              👁️
            </button>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Recent Reports Section -->
  <div class="bg-white rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">📈 Reportes Recientes</h3>
    
    <% if @recent_reports.any? %>
      <div class="space-y-3">
        <% @recent_reports.each do |report| %>
          <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-blue-600 text-sm">📊</span>
              </div>
              <div>
                <div class="text-sm font-medium text-gray-900"><%= report[:name] %></div>
                <div class="text-sm text-gray-500">Generado <%= report[:created_at] %></div>
              </div>
            </div>
            
            <div class="flex items-center space-x-2">
              <span class="text-sm text-gray-500"><%= report[:size] %></span>
              <button class="text-red-600 hover:text-red-700">
                ⬇️
              </button>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-8">
        <div class="text-gray-400 text-4xl mb-2">📊</div>
        <p class="text-gray-500">No hay reportes generados recientemente.</p>
        <p class="text-sm text-gray-400 mt-1">Los reportes aparecerán aquí una vez que los generes.</p>
      </div>
    <% end %>
  </div>

  <!-- Tips Section -->
  <div class="bg-blue-50 rounded-lg p-6">
    <h3 class="text-lg font-semibold text-blue-900 mb-4">💡 Consejos para Reportes</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700">
      <div>
        <h4 class="font-medium mb-2">📋 Filtros Inteligentes</h4>
        <ul class="space-y-1">
          <li>• Usa filtros de fecha para períodos específicos</li>
          <li>• Combina múltiples filtros para resultados precisos</li>
          <li>• Los reportes incluyen solo datos activos por defecto</li>
        </ul>
      </div>
      <div>
        <h4 class="font-medium mb-2">📄 Formato PDF</h4>
        <ul class="space-y-1">
          <li>• Los reportes incluyen encabezado institucional</li>
          <li>• Tablas optimizadas para impresión A4</li>
          <li>• Numeración automática de páginas</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
            <span class="text-blue-600 text-lg">👥</span>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Total Empleados</dt>
            <dd class="text-lg font-medium text-gray-900"><%= Employee.count %></dd>
          </dl>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
            <span class="text-green-600 text-lg">💳</span>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Cuentas de Pago</dt>
            <dd class="text-lg font-medium text-gray-900"><%= PaymentAccount.count %></dd>
          </dl>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
            <span class="text-purple-600 text-lg">👨‍👩‍👧‍👦</span>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Carga Familiar</dt>
            <dd class="text-lg font-medium text-gray-900"><%= FamilyMember.count %></dd>
          </dl>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
            <span class="text-yellow-600 text-lg">📊</span>
          </div>
        </div>
        <div class="ml-5 w-0 flex-1">
          <dl>
            <dt class="text-sm font-medium text-gray-500 truncate">Tipos de Reporte</dt>
            <dd class="text-lg font-medium text-gray-900"><%= @report_types.count %></dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function showReportPreview(reportType) {
    // Mostrar información sobre el tipo de reporte
    const reportNames = {
      'employees': 'Empleados',
      'payment_accounts': 'Cuentas de Pago',
      'family_detailed': 'Carga Familiar',
      'sizes': 'Tallas',
      'cards': 'Carnets',
      'vacation_report': 'Empleados en Vacaciones',
      'vacation_request': 'Solicitud de Vacaciones'
    };
    
    alert(`Vista previa del reporte de ${reportNames[reportType]}\n\nEste reporte incluye:\n- Encabezado institucional\n- Filtros aplicados\n- Datos en formato tabla\n- Numeración de páginas\n- Firmas de validación`);
  }
</script>

<style>
  /* Estilos para los botones de reportes */
  .btn-generate-report {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    background-color: #dc2626;
    color: white;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
    flex: 1;
    margin-right: 12px;
  }

  .btn-generate-report:hover {
    background-color: #b91c1c;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    color: white;
    text-decoration: none;
  }

  .btn-preview {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 16px;
    background-color: white;
    border: 2px solid #d1d5db;
    color: #374151;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-preview:hover {
    background-color: #f9fafb;
    border-color: #9ca3af;
    transform: translateY(-1px);
  }

  /* Asegurar que el contenedor flex funcione */
  .flex {
    display: flex !important;
  }

  .space-x-3 > * + * {
    margin-left: 12px !important;
  }

  /* Estilos para las tarjetas */
  .p-6 {
    padding: 24px !important;
  }

  /* Grid responsive mejorado */
  .grid {
    display: grid !important;
  }

  .grid-cols-1 {
    grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
  }

  @media (min-width: 768px) {
    .md\:grid-cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    }
  }

  @media (min-width: 1024px) {
    .lg\:grid-cols-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
    }
  }

  @media (min-width: 1280px) {
    .xl\:grid-cols-4 {
      grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
    }
  }

  .gap-6 {
    gap: 24px !important;
  }

  /* Responsive para botones */
  @media (max-width: 768px) {
    .btn-generate-report {
      flex: none;
      width: 100%;
      margin-right: 0;
      margin-bottom: 8px;
    }
    
    .flex {
      flex-direction: column !important;
    }
    
    .space-x-3 > * + * {
      margin-left: 0 !important;
    }
  }
</style>